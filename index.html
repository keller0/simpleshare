<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <title>Go share</title>
</head>
<body>

    <div style="text-align: center;max-width: 920px; margin: auto">
        <div><p>Share texts or files in your local network</p></div>
        <textarea name="" id="" cols="100" rows="10">{{ .data }}</textarea>
        <form action="/" method="POST" id="dForm">
            <textarea name="sData" id="sData" cols="100" rows="10" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);"></textarea>
            <br>
        </form>
        <form action="/clearFile" method="POST" id="cForm" style="display: none"></form>
        <div style="padding: 28px;">
            <input type="submit" value="Submit" form="dForm"  style="background: azure;">
            <button onclick="location.href = '/';" style="margin-left: 30px;background: gray;">Refresh</button>
            <button type="submit" form="cForm"  style="margin-left: 30px;background: #d25a5a;">DeleteFiles</button>
        </div>
        <div style="padding: 3px;" id="fileList">
            {{ range .fileList }}
            <a style="" href="{{.N}}">{{.Ns}}</a>
            {{ end }}
        </div>
        <br>
        <div id="imgList">
            {{ range .imaList }}
            <img style="width: 300px; padding: 5px" src="{{ . }}" alt="">
            {{ end }}
        </div>
    </div>

</body>
</html>
<style>
    textarea {
        /* will prevent resizing horizontally */
        max-width: 95%;
        resize:vertical;
    }
</style>
<script>

    function dropHandler(ev){
        console.log('File(s) dropped');

        // Prevent default behavior (Prevent file from being opened)
        ev.preventDefault();

        if (ev.dataTransfer.items) {
            // Use DataTransferItemList interface to access the file(s)
            for (let i = 0; i < ev.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (ev.dataTransfer.items[i].kind === 'file') {
                    let file = ev.dataTransfer.items[i].getAsFile();
                    console.log('... file[' + i + '].name = ' + file.name);
                    console.log(file)

                    let formData = new FormData();
                    formData.append("file", file);
                    formData.append("isImg", isFileImage(file)?"1":"0");

                    fetch('/upload', {method: "POST", body: formData})
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${ response.status }`);
                            }
                            return response.text();
                        }).then((response) => {
                        console.log(response)
                        if (isFileImage(file))
                        {
                            let elem = document.createElement("img");
                            elem.src = response;
                            elem.style.width = "300px";
                            elem.style.padding = "5px";
                            let list = document.getElementById("imgList");
                            list.insertBefore(elem, list.firstChild);
                        } else {
                            let elem = document.createElement("a");
                            elem.href = response;
                            elem.text = file.name;
                            let list = document.getElementById("fileList");
                            list.append(elem, list.firstChild);
                        }
                    });
                }
            }
        } else {
            // Use DataTransfer interface to access the file(s)
            for (let i = 0; i < ev.dataTransfer.files.length; i++) {
                console.log('... file[' + i + '].name = ' + ev.dataTransfer.files[i].name);
            }
        }
    }

    function isFileImage(file) {
        return file && file['type'].split('/')[0] === 'image';
    }

    function dragOverHandler(ev) {
        console.log('File(s) in drop zone');

        // Prevent default behavior (Prevent file from being opened)
        ev.preventDefault();
    }
</script>