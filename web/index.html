<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" type="image/x-icon" href="/static/web/favicon.ico">
    <title>simple share</title>
</head>
<body ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">

    <div class="container">
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <header class="header">
            <h1 class="title">simple share</h1>
            <p class="subtitle">Share texts and files in your local network</p>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- æ˜¾ç¤ºåŒºåŸŸ -->
            <section class="display-section">
                <label class="section-label">Shared Content</label>
                <textarea id="showDataArea" class="display-area" readonly>{{ .data }}</textarea>
            </section>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <section class="input-section">
                <label class="section-label">Input Text</label>
                <textarea name="sData" id="inputDataArea" class="input-area" 
                          placeholder="Input text and submit or drop files on the page"></textarea>
                
                           <!-- æ“ä½œæŒ‰é’® -->
                <div class="action-buttons">
                    <button onclick="submitText()" class="btn btn-primary">Submit</button>
                    <button onclick="fetchData()" class="btn btn-secondary">Fetch</button>
                    <button onclick="confirmDeleteAllFiles()" class="btn btn-danger">Clear All</button>
                </div>
                
                <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-section">
                    <label class="section-label">Upload Files</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="upLoadOneFile" multiple onchange="handleSelectFilesChange(this)" class="file-input">
                        <label for="upLoadOneFile" class="file-input-label">
                            <span class="upload-icon">ğŸ“</span>
                            <span>Choose files or drag & drop</span>
                        </label>
                    </div>
                </div>

               
            </section>

            <!-- ä¸Šä¼ è¿›åº¦åŒºåŸŸ -->
            <section id="uploadProgress" class="upload-progress" style="display: none;">
                <div class="progress-header">
                    <span class="progress-title">Uploading files...</span>
                </div>
                <div id="progressList" class="progress-list"></div>
            </section>

            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <section class="files-section">
                <label class="section-label">Files</label>
                <div id="fileList" class="file-list">
                    {{ range .fileList }}
                    <div class="file-item">
                        <a href="{{.N}}" class="file-link">{{.Ns}}</a>
                        <button onclick="deleteFile('{{.Ns}}')" class="delete-btn" title="Delete file">Ã—</button>
                    </div>
                    {{ end }}
                </div>
            </section>

            <!-- å›¾ç‰‡åˆ—è¡¨ -->
            <section class="images-section">
                <label class="section-label">Images</label>
                <div id="imgList" class="image-list">
                    {{ range .imgList }}
                    <div class="image-item">
                        <img src="{{ . }}" alt="" class="image" onclick="openImageModal('{{ . }}')">
                        <button class="image-delete-btn" title="Delete image" data-filename="{{ . }}">Ã—</button>
                    </div>
                    {{ end }}
                </div>
            </section>

            <!-- å›¾ç‰‡æ¨¡æ€æ¡† -->
            <div id="imageModal" class="image-modal" onclick="closeImageModal()">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <span class="modal-title">Image Viewer</span>
                        <button class="modal-close" onclick="closeImageModal()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <img id="modalImage" src="" alt="" class="modal-image">
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="downloadImage()">Download</button>
                        <button class="btn btn-danger" onclick="deleteCurrentImage()">Delete</button>
                        <button class="btn btn-primary" onclick="closeImageModal()">Close</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

</body>
</html>

<style>
    /* åŸºç¡€æ ·å¼é‡ç½® */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
        background: #0a0a0a;
        color: #00ff00;
        line-height: 1.6;
        overflow-x: hidden;
    }

    /* å®¹å™¨ */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* æ ‡é¢˜åŒºåŸŸ */
    .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 20px 0;
        border-bottom: 1px solid #333;
    }

    .title {
        font-size: 2.5rem;
        font-weight: bold;
        color: #00ff00;
        text-shadow: 0 0 10px #00ff00;
        margin-bottom: 10px;
        letter-spacing: 2px;
        text-align: left;
    }

    .subtitle {
        font-size: 1rem;
        color: #666;
        font-style: italic;
        text-align: left;
    }

    /* ä¸»è¦å†…å®¹åŒºåŸŸ */
    .main-content {
        display: grid;
        gap: 30px;
    }

    /* é€šç”¨åŒºå—æ ·å¼ */
    .display-section,
    .input-section,
    .files-section,
    .images-section {
        background: #111;
        border: 1px solid #333;
        border-radius: 4px;
        padding: 20px;
    }

    .section-label {
        display: block;
        font-size: 0.9rem;
        font-weight: bold;
        color: #00ff00;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* æ–‡æœ¬åŒºåŸŸ */
    .display-area,
    .input-area {
        width: 100%;
        min-height: 120px;
        background: #000;
        border: 1px solid #333;
        border-radius: 2px;
        color: #00ff00;
        font-family: inherit;
        font-size: 0.9rem;
        padding: 15px;
        resize: vertical;
        outline: none;
        transition: border-color 0.2s ease;
    }

    .display-area {
        background: #0a0a0a;
        color: #ccc;
        border-color: #444;
    }

    .input-area:focus {
        border-color: #00ff00;
        box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
    }

    /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
    .upload-section {
        margin: 20px 0;
    }

    .file-input-wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    .file-input-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 15px;
        background: #000;
        border: 2px dashed #333;
        border-radius: 4px;
        color: #666;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .file-input-label:hover {
        border-color: #00ff00;
        color: #00ff00;
    }

    .upload-icon {
        font-size: 1.2rem;
    }

    /* æŒ‰é’®æ ·å¼ */
    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn {
        padding: 10px 20px;
        border: 1px solid #333;
        background: #000;
        color: #00ff00;
        font-family: inherit;
        font-size: 0.9rem;
        cursor: pointer;
        border-radius: 2px;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn:hover {
        background: #00ff00;
        color: #000;
        border-color: #00ff00;
    }

    .btn-primary {
        border-color: #00ff00;
        color: #00ff00;
    }

    .btn-primary:hover {
        background: #00ff00;
        color: #000;
    }

    .btn-secondary {
        border-color: #0066cc;
        color: #0066cc;
    }

    .btn-secondary:hover {
        background: #0066cc;
        color: #000;
    }

    .btn-danger {
        border-color: #cc0000;
        color: #cc0000;
    }

    .btn-danger:hover {
        background: #cc0000;
        color: #000;
    }

    /* ä¸Šä¼ è¿›åº¦ */
    .upload-progress {
        background: #111;
        border: 1px solid #333;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-header {
        background: #000;
        padding: 15px;
        border-bottom: 1px solid #333;
        text-align: center;
        font-weight: bold;
    }

    .progress-list {
        padding: 0;
    }

    .progress-item {
        padding: 15px;
        border-bottom: 1px solid #333;
        background: #0a0a0a;
    }

    .progress-item:last-child {
        border-bottom: none;
    }

    .progress-item-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #00ff00;
        animation: pulse 1s infinite;
    }

    .status-uploading {
        background: #ffaa00;
    }

    .status-success {
        background: #00ff00;
    }

    .status-error,
    .status-cancelled {
        background: #ff0000;
    }

    .progress-bar {
        width: 100%;
        height: 4px;
        background: #333;
        border-radius: 2px;
        overflow: hidden;
        margin: 10px 0;
    }

    .progress-fill {
        height: 100%;
        background: #00ff00;
        width: 0%;
        transition: width 0.3s ease;
    }

    .progress-info {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #666;
    }

    .cancel-btn {
        background: #ff0000;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 10px;
    }

    .cancel-btn:hover {
        background: #cc0000;
    }

    /* æ–‡ä»¶åˆ—è¡¨ */
    .file-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .file-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        background: #000;
        border: 1px solid #333;
        border-radius: 2px;
        transition: all 0.2s ease;
    }

    .file-item:hover {
        border-color: #00ff00;
        background: #0a0a0a;
    }

    .file-link {
        color: #00ff00;
        text-decoration: none;
        font-size: 0.9rem;
    }

    .file-link:hover {
        text-decoration: underline;
    }

    /* å›¾ç‰‡åˆ—è¡¨ */
    .image-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }

    .image-item {
        position: relative;
        background: #000;
        border: 1px solid #333;
        border-radius: 4px;
        overflow: hidden;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .image-item:hover {
        border-color: #00ff00;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 255, 0, 0.2);
    }

    .image {
        width: 100%;
        height: 150px;
        object-fit: cover;
        display: block;
        transition: transform 0.3s ease;
    }

    .image-item:hover .image {
        transform: scale(1.05);
    }

        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        .delete-btn {
        background: none;
        border: none;
        color: #ff0000;
        cursor: pointer;
        font-size: 16px;
        padding: 2px;
        border-radius: 2px;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .delete-btn:hover {
        background: rgba(255, 0, 0, 0.2);
    }


    /* åˆ é™¤æŒ‰é’®ç§»åˆ°å³ä¸Šè§’ */
    .image-delete-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        opacity: 0;
        z-index: 10;
    }

    .image-item:hover .image-delete-btn {
        opacity: 1;
    }

    .image-delete-btn:hover {
        background: #ff0000;
        transform: scale(1.1);
    }

    /* å›¾ç‰‡æ¨¡æ€æ¡† */
    .image-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
        cursor: pointer; /* è¡¨ç¤ºå¯ä»¥ç‚¹å‡»å…³é—­ */
    }

    .modal-content {
        position: relative;
        margin: 2% auto;
        width: 90%;
        max-width: 800px;
        height: 90%;
        background: #111;
        border: 1px solid #333;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        animation: slideIn 0.3s ease;
        cursor: default; /* å†…å®¹åŒºåŸŸä¸æ˜¾ç¤ºæ‰‹å‹å…‰æ ‡ */
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #333;
        background: #000;
        border-radius: 8px 8px 0 0;
    }

    .modal-title {
        font-size: 1.1rem;
        font-weight: bold;
        color: #00ff00;
    }

    .modal-close {
        background: none;
        border: none;
        color: #666;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: #333;
        color: #00ff00;
    }

    .modal-body {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow: hidden;
    }

    .modal-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 4px;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
    }

    .modal-footer {
        display: flex;
        justify-content: center;
        gap: 15px;
        padding: 15px 20px;
        border-top: 1px solid #333;
        background: #000;
        border-radius: 0 0 8px 8px;
    }

    /* åŠ¨ç”» */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateY(0);
            opacity: 1;
        }
        to {
            transform: translateY(-50px);
            opacity: 0;
        }
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .container {
            padding: 10px;
        }

        .title {
            font-size: 2rem;
        }

        .action-buttons {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }

        .image-list {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }

        .image {
            height: 120px;
        }

        .modal-content {
            width: 95%;
            height: 95%;
            margin: 2.5% auto;
        }

        .modal-footer {
            flex-direction: column;
            gap: 10px;
        }
    }

    /* æ»šåŠ¨æ¡æ ·å¼ */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #000;
    }

    ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #00ff00;
    }

    /* é€‰æ‹©æ–‡æœ¬æ ·å¼ */
    ::selection {
        background: #00ff00;
        color: #000;
    }

    ::-moz-selection {
        background: #00ff00;
        color: #000;
    }
</style>

<script>
    let uploadRequests = new Map(); // å­˜å‚¨æ‰€æœ‰ä¸Šä¼ è¯·æ±‚

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showProgress() {
        document.getElementById('uploadProgress').style.display = 'block';
    }

    function hideProgress() {
        document.getElementById('uploadProgress').style.display = 'none';
        document.getElementById('progressList').innerHTML = '';
    }

    // æ·»åŠ è‡ªåŠ¨éšè—åŠŸèƒ½
    function autoHideProgress() {
        setTimeout(() => {
            const progressList = document.getElementById('progressList');
            if (progressList.children.length === 0) {
                hideProgress();
            }
        }, 2000);
    }

    function createProgressItem(fileName, fileSize) {
        const progressId = 'progress-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        const progressItem = document.createElement('div');
        progressItem.className = 'progress-item';
        progressItem.id = progressId;
        progressItem.innerHTML = `
            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                <span class="status-indicator status-uploading"></span>
                <span style="flex: 1;">${fileName}</span>
                <span style="color: #666; font-size: 12px;">${formatFileSize(fileSize)}</span>
                <button onclick="cancelUpload('${progressId}', '${fileName}')" class="cancel-btn" title="Cancel upload">âœ•</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="fill-${progressId}"></div>
            </div>
            <div class="progress-info">
                <span id="status-${progressId}">Uploading...</span>
                <span id="percent-${progressId}">0%</span>
            </div>
        `;
        
        document.getElementById('progressList').appendChild(progressItem);
        return progressId;
    }

    function cancelUpload(progressId, fileName) {
        if (!confirm(`Are you sure you want to cancel uploading "${fileName}"?`)) {
            return;
        }

        // å–æ¶ˆç‰¹å®šçš„ XHR è¯·æ±‚
        const xhr = uploadRequests.get(progressId);
        if (xhr) {
            xhr.abort();
            uploadRequests.delete(progressId);
        }
        
        // æ›´æ–°è¿›åº¦æ¡çŠ¶æ€
        updateProgress(progressId, 0, 'Cancelled');
        
        // 2ç§’åç§»é™¤è¿›åº¦é¡¹
        setTimeout(() => {
            const progressItem = document.getElementById(progressId);
            if (progressItem) {
                progressItem.remove();
            }
            
            // å¦‚æœæ²¡æœ‰æ›´å¤šè¿›åº¦é¡¹ï¼Œéšè—è¿›åº¦åŒºåŸŸ
            const progressList = document.getElementById('progressList');
            if (progressList.children.length === 0) {
                hideProgress();
            }
        }, 2000);
    }

    function updateProgress(progressId, percent, status) {
        const fillElement = document.getElementById(`fill-${progressId}`);
        const statusElement = document.getElementById(`status-${progressId}`);
        const percentElement = document.getElementById(`percent-${progressId}`);
        const indicatorElement = fillElement.parentElement.parentElement.querySelector('.status-indicator');
        
        if (fillElement) fillElement.style.width = percent + '%';
        if (percentElement) percentElement.textContent = Math.round(percent) + '%';
        if (statusElement) statusElement.textContent = status;
        
        if (status === 'Completed') {
            indicatorElement.className = 'status-indicator status-success';
        } else if (status === 'Error') {
            indicatorElement.className = 'status-indicator status-error';
        } else if (status === 'Cancelled') {
            indicatorElement.className = 'status-indicator status-cancelled';
        }
    }

    function deleteFile(fileName) {
        if (!confirm(`Are you sure you want to delete "${fileName}"?`)) {
            return;
        }

        const formData = new FormData();
        formData.append('fileName', fileName);

        fetch('/deleteFile', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // åªç§»é™¤å¯¹åº”çš„DOMå…ƒç´ ï¼Œä¸åˆ·æ–°é¡µé¢
                removeFileFromDOM(fileName);
                showMessage('File deleted successfully!', 'success');
            } else {
                showMessage('Error deleting file: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error deleting file. Please try again.', 'error');
        });
    }

    // æ·»åŠ ç¼ºå¤±çš„å‡½æ•°ï¼šä»DOMä¸­ç§»é™¤æ–‡ä»¶
    function removeFileFromDOM(fileName) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡æ–‡ä»¶
        const isImage = isImageFile(fileName);
        
        if (isImage) {
            // ä»å›¾ç‰‡åˆ—è¡¨ä¸­ç§»é™¤
            const imageItems = document.querySelectorAll('.image-item');
            imageItems.forEach(item => {
                const img = item.querySelector('.image');
                if (img && img.src.includes(fileName)) {
                    // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
                    item.style.transition = 'all 0.3s ease';
                    item.style.opacity = '0';
                    item.style.transform = 'scale(0.8)';
                    
                    setTimeout(() => {
                        item.remove();
                    }, 300);
                }
            });
        } else {
            // ä»æ–‡ä»¶åˆ—è¡¨ä¸­ç§»é™¤
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach(item => {
                const link = item.querySelector('.file-link');
                if (link && link.textContent === fileName) {
                    // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
                    item.style.transition = 'all 0.3s ease';
                    item.style.opacity = '0';
                    item.style.transform = 'translateX(-20px)';
                    
                    setTimeout(() => {
                        item.remove();
                    }, 300);
                }
            });
        }
    }

    // æ·»åŠ ç¼ºå¤±çš„å‡½æ•°ï¼šæ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºå›¾ç‰‡
    function isImageFile(fileName) {
        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg'];
        const extension = fileName.toLowerCase().substring(fileName.lastIndexOf('.'));
        return imageExtensions.includes(extension);
    }

    function confirmDeleteAllFiles() {
        if (confirm('Are you sure you want to delete ALL files? This action cannot be undone.')) {
            clearAllFilesAndMsg();
        }
    }

    function clearAllFilesAndMsg() {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const clearBtn = document.querySelector('.btn-danger');
        const originalText = clearBtn.textContent;
        clearBtn.textContent = 'Clearing...';
        clearBtn.disabled = true;

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/clearAll', true);
        
        xhr.onload = function() {
            clearBtn.textContent = originalText;
            clearBtn.disabled = false;
            
            if (xhr.status === 200) {
                // æ¥å£è°ƒç”¨æˆåŠŸï¼Œç›´æ¥åˆ·æ–°é¡µé¢
                location.reload();
            } else {
                showMessage('Error clearing files. Please try again.', 'error');
            }
        };

        xhr.onerror = function() {
            clearBtn.textContent = originalText;
            clearBtn.disabled = false;
            showMessage('Network error. Please try again.', 'error');
        };

        xhr.ontimeout = function() {
            clearBtn.textContent = originalText;
            clearBtn.disabled = false;
            showMessage('Request timeout. Please try again.', 'error');
        };

        // è®¾ç½®è¶…æ—¶æ—¶é—´
        xhr.timeout = 10000; // 10ç§’

        xhr.send();
    }

    function dropHandler(ev){
        console.log('File(s) dropped');
        ev.preventDefault();

        if (ev.dataTransfer.items) {
            for (let i = 0; i < ev.dataTransfer.items.length; i++) {
                if (ev.dataTransfer.items[i].kind === 'file') {
                    let file = ev.dataTransfer.items[i].getAsFile();
                    console.log('... file[' + i + '].name = ' + file.name);
                    uploadFile(file);
                }
            }
        } else {
            for (let i = 0; i < ev.dataTransfer.files.length; i++) {
                console.log('... file[' + i + '].name = ' + ev.dataTransfer.files[i].name);
                uploadFile(ev.dataTransfer.files[i]);
            }
        }
    }

    function handleSelectFilesChange(input) {
        console.log(input.files);
        for(let i = 0; i < input.files.length; i++) {
            let file = input.files[i];
            uploadFile(file);
        }
        // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
        input.value = '';
    }

    function uploadFile(file) {
        showProgress();
        const progressId = createProgressItem(file.name, file.size);

        const formData = new FormData();
        formData.append('file', file);
        formData.append("isImg", isFileImage(file)?"1":"0");
        
        const xhr = new XMLHttpRequest();
        uploadRequests.set(progressId, xhr); // å­˜å‚¨è¯·æ±‚å¼•ç”¨
        xhr.open('POST', '/upload', true);
        
        xhr.upload.onprogress = e => {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                updateProgress(progressId, percentComplete, 'Uploading...');
            }
        };
        
        xhr.onload = function(e) {
            uploadRequests.delete(progressId);
            console.log(e);
            if (xhr.status === 200) {
                updateProgress(progressId, 100, 'Completed');
                
                setTimeout(() => {
                    if (isFileImage(file)) {
                        let imgContainer = document.createElement("div");
                        imgContainer.className = "image-item";
                        imgContainer.innerHTML = `
                            <img src="${e.currentTarget.response}" alt="" class="image" onclick="openImageModal('${e.currentTarget.response}')">
                            <button class="image-delete-btn" title="Delete image" data-filename="${file.name}">Ã—</button>
                        `;
                        let list = document.getElementById("imgList");
                        list.insertBefore(imgContainer, list.firstChild);
                        
                        // ä¸ºæ–°æ·»åŠ çš„å›¾ç‰‡åˆ é™¤æŒ‰é’®ç»‘å®šäº‹ä»¶
                        const newDeleteBtn = imgContainer.querySelector('.image-delete-btn');
                        newDeleteBtn.addEventListener('click', function(e) {
                            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                            const filename = this.getAttribute('data-filename');
                            if (filename) {
                                deleteFile(filename);
                            }
                        });
                    } else {
                        let fileContainer = document.createElement("div");
                        fileContainer.className = "file-item";
                        fileContainer.innerHTML = `
                            <a href="${e.currentTarget.response}" class="file-link">${file.name}</a>
                            <button onclick="deleteFile('${file.name}')" class="delete-btn" title="Delete file">Ã—</button>
                        `;
                        let list = document.getElementById("fileList");
                        list.insertBefore(fileContainer, list.firstChild);
                    }
                    
                    // ç§»é™¤è¿›åº¦é¡¹
                    const progressItem = document.getElementById(progressId);
                    if (progressItem) {
                        progressItem.remove();
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–è¿›åº¦é¡¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™2ç§’åè‡ªåŠ¨éšè—
                    const progressList = document.getElementById('progressList');
                    if (progressList.children.length === 0) {
                        autoHideProgress();
                    }
                }, 1000);
            } else {
                updateProgress(progressId, 0, 'Error');
                alert("Error uploading file: " + file.name + ". Please try again.");
                
                // é”™è¯¯æƒ…å†µä¸‹ä¹Ÿç§»é™¤è¿›åº¦é¡¹å¹¶æ£€æŸ¥è‡ªåŠ¨éšè—
                setTimeout(() => {
                    const progressItem = document.getElementById(progressId);
                    if (progressItem) {
                        progressItem.remove();
                    }
                    
                    const progressList = document.getElementById('progressList');
                    if (progressList.children.length === 0) {
                        autoHideProgress();
                    }
                }, 3000); // é”™è¯¯æƒ…å†µä¸‹3ç§’åç§»é™¤
            }
        };

        xhr.onerror = function() {
            uploadRequests.delete(progressId);
            updateProgress(progressId, 0, 'Error');
            alert("Network error uploading file: " + file.name + ". Please try again.");
            
            // é”™è¯¯æƒ…å†µä¸‹ä¹Ÿç§»é™¤è¿›åº¦é¡¹å¹¶æ£€æŸ¥è‡ªåŠ¨éšè—
            setTimeout(() => {
                const progressItem = document.getElementById(progressId);
                if (progressItem) {
                    progressItem.remove();
                }
                
                const progressList = document.getElementById('progressList');
                if (progressList.children.length === 0) {
                    autoHideProgress();
                }
            }, 3000); // é”™è¯¯æƒ…å†µä¸‹3ç§’åç§»é™¤
        };

        xhr.onabort = function() {
            uploadRequests.delete(progressId);
            updateProgress(progressId, 0, 'Cancelled');
            
            setTimeout(() => {
                const progressItem = document.getElementById(progressId);
                if (progressItem) {
                    progressItem.remove();
                }
                
                // å¦‚æœæ²¡æœ‰æ›´å¤šè¿›åº¦é¡¹ï¼Œéšè—è¿›åº¦åŒºåŸŸ
                const progressList = document.getElementById('progressList');
                if (progressList.children.length === 0) {
                    hideProgress();
                }
            }, 2000);
        };

        xhr.send(formData);
    }

    function isFileImage(file) {
        return file && file['type'].split('/')[0] === 'image';
    }

    function dragOverHandler(ev) {
        console.log('File(s) in drop zone');
        ev.preventDefault();
    }

    // ä¿®æ”¹äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿æ­£ç¡®å¤„ç†å›¾ç‰‡åˆ é™¤
    document.addEventListener('DOMContentLoaded', function() {
        // ä¸ºç°æœ‰çš„å›¾ç‰‡åˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.querySelectorAll('.image-delete-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                const filename = this.getAttribute('data-filename');
                if (filename) {
                    const actualFilename = filename.replace('tFile/', '');
                    deleteFile(actualFilename);
                }
            });
        });
    });

    // æ·»åŠ æ–°çš„å‡½æ•°æ¥å¤„ç†æ–‡æœ¬æäº¤å’Œè·å–æ•°æ®
    function submitText() {
        const textData = document.getElementById('inputDataArea').value;
        
        const formData = new FormData();
        formData.append('sData', textData);

        fetch('/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(html => {
            // è§£æè¿”å›çš„HTMLå¹¶æ›´æ–°æ˜¾ç¤ºåŒºåŸŸ
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // æ›´æ–°æ˜¾ç¤ºåŒºåŸŸçš„æ–‡æœ¬
            const newData = doc.querySelector('#showDataArea').textContent;
            document.getElementById('showDataArea').value = newData;
            
            // æ¸…ç©ºè¾“å…¥åŒºåŸŸ
            document.getElementById('inputDataArea').value = '';
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showMessage('Text submitted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error submitting text. Please try again.', 'error');
        });
    }

    function fetchData() {
        fetch('/')
        .then(response => response.text())
        .then(html => {
            // è§£æè¿”å›çš„HTMLå¹¶æ›´æ–°é¡µé¢å†…å®¹
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // æ›´æ–°æ˜¾ç¤ºåŒºåŸŸçš„æ–‡æœ¬
            const newData = doc.querySelector('#showDataArea').textContent;
            document.getElementById('showDataArea').value = newData;
            
            // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
            updateFileList(doc);
            
            // æ›´æ–°å›¾ç‰‡åˆ—è¡¨
            updateImageList(doc);
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showMessage('Data fetched successfully!', 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error fetching data. Please try again.', 'error');
        });
    }

    function updateFileList(doc) {
        const newFileList = doc.querySelector('#fileList');
        const currentFileList = document.getElementById('fileList');
        
        if (newFileList && currentFileList) {
            currentFileList.innerHTML = newFileList.innerHTML;
        }
    }

    function updateImageList(doc) {
        const newImgList = doc.querySelector('#imgList');
        const currentImgList = document.getElementById('imgList');
        
        if (newImgList && currentImgList) {
            currentImgList.innerHTML = newImgList.innerHTML;
            
            // é‡æ–°ç»‘å®šå›¾ç‰‡åˆ é™¤æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
            setTimeout(() => {
                document.querySelectorAll('.image-delete-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                        const filename = this.getAttribute('data-filename');
                        if (filename) {
                            const actualFilename = filename.replace('tFile/', '');
                            deleteFile(actualFilename);
                        }
                    });
                });
            }, 100);
        }
    }

    function showMessage(message, type) {
        // åˆ›å»ºæ¶ˆæ¯æç¤ºå…ƒç´ 
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            font-family: inherit;
            border: 1px solid;
            animation: slideIn 0.3s ease;
        `;
        
        if (type === 'success') {
            messageDiv.style.background = '#000';
            messageDiv.style.borderColor = '#00ff00';
            messageDiv.style.color = '#00ff00';
        } else if (type === 'error') {
            messageDiv.style.background = '#000';
            messageDiv.style.borderColor = '#ff0000';
            messageDiv.style.color = '#ff0000';
        }
        
        document.body.appendChild(messageDiv);
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            messageDiv.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300);
        }, 3000);
    }

    // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', function(e) {
        // Ctrl+Enter æäº¤æ–‡æœ¬
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            submitText();
        }
        
        // F5 è·å–æ•°æ®
        if (e.key === 'F5') {
            e.preventDefault();
            fetchData();
        }
    });

    // å›¾ç‰‡æ¨¡æ€æ¡†ç›¸å…³å‡½æ•°
    let currentModalImage = null;

    function openImageModal(imageSrc) {
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        
        currentModalImage = imageSrc;
        modalImage.src = imageSrc;
        modal.style.display = 'block';
        
        // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = 'hidden';
        
        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
        document.addEventListener('keydown', handleModalKeydown);
    }

    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.style.display = 'none';
        
        // æ¢å¤èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = 'auto';
        
        // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬
        document.removeEventListener('keydown', handleModalKeydown);
        
        currentModalImage = null;
    }

    function handleModalKeydown(e) {
        if (e.key === 'Escape') {
            closeImageModal();
        }
    }

    function downloadImage() {
        if (currentModalImage) {
            const link = document.createElement('a');
            link.href = currentModalImage;
            link.download = currentModalImage.split('/').pop();
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    function deleteCurrentImage() {
        if (currentModalImage) {
            const filename = currentModalImage.replace('tFile/', '');
            closeImageModal();
            deleteFile(filename);
        }
    }
</script>