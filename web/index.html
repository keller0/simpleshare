<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" type="image/x-icon" href="/static/web/favicon.ico">
    <title>simple share</title>
</head>
<body ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">

    <div style="text-align: center;max-width: 920px; margin: auto">
        <div><p style="font-weight: bold;">Share texts and files in your local network</p></div>
        <textarea name="" id="showDataArea" cols="100" rows="15">{{ .data }}</textarea>
        <div id="div-mobile" class="up-box">
            <!-- <input name="photo" type="file" id="upLoadOneFile" accept="image/*"> -->
            <input name="photo" type="file" id="upLoadOneFile" multiple onchange="handleSelectFilesChange(this)" >
        </div>
        <form action="/" method="POST" id="dForm">
            <textarea name="sData" id="inputDataArea" cols="100" rows="4"
             placeholder="Input text and submit or drop files on the page"></textarea>
            <br>
        </form>
        <form action="/clearFile" method="POST" id="cForm" style="display: none"></form>
        <div style="padding: 28px;">
            <input type="submit" value="Submit" form="dForm"  style="background: azure;">
            <button onclick="location.href = '/';" style="margin-left: 30px;background: gray;">Refresh</button>
            <button onclick="confirmDeleteAllFiles()" style="margin-left: 30px;background: #d25a5a;">DeleteFiles</button>
        </div>
        
        <!-- ‰∏ä‰º†ËøõÂ∫¶Âå∫Âüü -->
        <div id="uploadProgress" class="upload-progress-container" style="display: none;">
            <div class="progress-header">
                <span id="progressTitle">Uploading files...</span>
            </div>
            <div id="progressList"></div>
        </div>

        <!-- Êñá‰ª∂ÂàóË°® -->
        <div style="margin: 10px auto auto; width: 90%" id="fileList">
            {{ range .fileList }}
            <div class="file-item">
                <a href="{{.N}}" class="file-link">{{.Ns}}</a>
                <button onclick="deleteFile('{{.Ns}}')" class="delete-btn" title="Delete file">üóëÔ∏è</button>
            </div>
            {{ end }}
        </div>
        <br>
        
        <!-- ÂõæÁâáÂàóË°® -->
        <div id="imgList" class="img-list">
            {{ range .imgList }}
            <div class="img-item">
                <img src="{{ . }}" alt="">
                <button class="delete-btn img-delete-btn" title="Delete image" data-filename="{{ . }}">üóëÔ∏è</button>
            </div>
            {{ end }}
        </div>
    </div>

</body>
</html>
<style>
    body {
        border-bottom: 1px #cfc4c4 solid;
        min-height: 100vh;
        overflow: auto;
        font-family: Arial, sans-serif;
    }
    textarea {
        /* will prevent resizing horizontally */
        max-width: 95%;
        resize:vertical;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px;
    }
    .progress-bar {
        width: 90%;
        margin: auto;
        background-color: #ddd;
    }
    @media screen and (min-width: 769px) {
        #div-mobile { display: none; }
        #div-desktop { display: block; }

        #inputDataArea {width: 700px;}
        #showDataArea {width: 700px;}
        .progress-bar{width: 700px;}
    }

    @media screen and (max-width: 768px) {
        #div-mobile { display: block; }
        #div-desktop { display: none; }
        
        .img-item img {
            width: 250px;
        }
    }
    .up-box{
        margin: 5px;
        text-align: left;
    }
    #progress {
        width: 0%;
        height: 1em;
        background-color: #4CAF50;
        text-align: left;
    }
    #progressName {
        width: 100%;
        text-align: left;
    }

    /* ‰∏ä‰º†ËøõÂ∫¶Ê†∑Âºè */
    .upload-progress-container {
        width: 90%;
        margin: 20px auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f9f9f9;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .progress-header {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px 15px;
        background: #e9ecef;
        border-radius: 8px 8px 0 0;
        border-bottom: 1px solid #ddd;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #666;
    }
    
    .close-btn:hover {
        color: #333;
    }
    
    .progress-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
    }
    
    .progress-item:last-child {
        border-bottom: none;
    }
    
    .progress-bar {
        width: 100%;
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 5px;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4CAF50, #45a049);
        width: 0%;
        transition: width 0.3s ease;
    }
    
    .progress-info {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }
    
    /* Êñá‰ª∂È°πÊ†∑Âºè */
    .file-item {
        display: inline-flex;
        align-items: center;
        margin: 5px 10px 5px 0;
        padding: 5px 10px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    
    .file-item:hover {
        background: #e9ecef;
        border-color: #adb5bd;
    }
    
    .file-link {
        text-decoration: none;
        color: #007bff;
        margin-right: 8px;
    }
    
    .file-link:hover {
        text-decoration: underline;
    }
    
    .delete-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        padding: 2px 4px;
        border-radius: 3px;
        transition: background-color 0.2s ease;
    }
    
    .delete-btn:hover {
        background-color: #ffebee;
    }
    
    /* ÂõæÁâáÈ°πÊ†∑Âºè */
    .img-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
    }
    
    .img-item {
        position: relative;
        display: inline-block;
    }
    
    .img-item img {
        width: 300px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        transition: transform 0.2s ease;
    }
    
    .img-item:hover img {
        transform: scale(1.02);
    }
    
    .img-delete-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #ddd;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .img-item:hover .img-delete-btn {
        opacity: 1;
    }
    
    /* Áä∂ÊÄÅÊåáÁ§∫Âô® */
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-uploading {
        background: #ffc107;
        animation: pulse 1s infinite;
    }
    
    .status-success {
        background: #28a745;
    }
    
    .status-error {
        background: #dc3545;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    /* ÂèñÊ∂àÊåâÈíÆÊ†∑Âºè */
    .cancel-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
    }
    
    .cancel-btn:hover {
        background: #c82333;
    }
    
    .status-cancelled {
        background: #6c757d;
    }
</style>
<script>
    let uploadRequests = new Map(); // Â≠òÂÇ®ÊâÄÊúâ‰∏ä‰º†ËØ∑Ê±Ç

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showProgress() {
        document.getElementById('uploadProgress').style.display = 'block';
    }

    function hideProgress() {
        document.getElementById('uploadProgress').style.display = 'none';
        document.getElementById('progressList').innerHTML = '';
    }

    // Ê∑ªÂä†Ëá™Âä®ÈöêËóèÂäüËÉΩ
    function autoHideProgress() {
        setTimeout(() => {
            const progressList = document.getElementById('progressList');
            if (progressList.children.length === 0) {
                hideProgress();
            }
        }, 2000);
    }

    function createProgressItem(fileName, fileSize) {
        const progressId = 'progress-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        const progressItem = document.createElement('div');
        progressItem.className = 'progress-item';
        progressItem.id = progressId;
        progressItem.innerHTML = `
            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                <span class="status-indicator status-uploading"></span>
                <span style="flex: 1;">${fileName}</span>
                <span style="color: #666; font-size: 12px;">${formatFileSize(fileSize)}</span>
                <button onclick="cancelUpload('${progressId}', '${fileName}')" class="cancel-btn" title="Cancel upload">‚úï</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="fill-${progressId}"></div>
            </div>
            <div class="progress-info">
                <span id="status-${progressId}">Uploading...</span>
                <span id="percent-${progressId}">0%</span>
            </div>
        `;
        
        document.getElementById('progressList').appendChild(progressItem);
        return progressId;
    }

    function cancelUpload(progressId, fileName) {
        if (!confirm(`Are you sure you want to cancel uploading "${fileName}"?`)) {
            return;
        }

        // ÂèñÊ∂àÁâπÂÆöÁöÑ XHR ËØ∑Ê±Ç
        const xhr = uploadRequests.get(progressId);
        if (xhr) {
            xhr.abort();
            uploadRequests.delete(progressId);
        }
        
        // Êõ¥Êñ∞ËøõÂ∫¶Êù°Áä∂ÊÄÅ
        updateProgress(progressId, 0, 'Cancelled');
        
        // 2ÁßíÂêéÁßªÈô§ËøõÂ∫¶È°π
        setTimeout(() => {
            const progressItem = document.getElementById(progressId);
            if (progressItem) {
                progressItem.remove();
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâÊõ¥Â§öËøõÂ∫¶È°πÔºåÈöêËóèËøõÂ∫¶Âå∫Âüü
            const progressList = document.getElementById('progressList');
            if (progressList.children.length === 0) {
                hideProgress();
            }
        }, 2000);
    }

    function updateProgress(progressId, percent, status) {
        const fillElement = document.getElementById(`fill-${progressId}`);
        const statusElement = document.getElementById(`status-${progressId}`);
        const percentElement = document.getElementById(`percent-${progressId}`);
        const indicatorElement = fillElement.parentElement.parentElement.querySelector('.status-indicator');
        
        if (fillElement) fillElement.style.width = percent + '%';
        if (percentElement) percentElement.textContent = Math.round(percent) + '%';
        if (statusElement) statusElement.textContent = status;
        
        if (status === 'Completed') {
            indicatorElement.className = 'status-indicator status-success';
        } else if (status === 'Error') {
            indicatorElement.className = 'status-indicator status-error';
        } else if (status === 'Cancelled') {
            indicatorElement.className = 'status-indicator status-cancelled';
        }
    }

    function deleteFile(fileName) {
        if (!confirm(`Are you sure you want to delete "${fileName}"?`)) {
            return;
        }

        const formData = new FormData();
        formData.append('fileName', fileName);

        fetch('/deleteFile', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Âà∑Êñ∞È°µÈù¢‰ª•Êõ¥Êñ∞Êñá‰ª∂ÂàóË°®
                location.reload();
            } else {
                alert('Error deleting file: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting file. Please try again.');
        });
    }

    function confirmDeleteAllFiles() {
        if (confirm('Are you sure you want to delete ALL files? This action cannot be undone.')) {
            document.getElementById('cForm').submit();
        }
    }

    function dropHandler(ev){
        console.log('File(s) dropped');
        ev.preventDefault();

        if (ev.dataTransfer.items) {
            for (let i = 0; i < ev.dataTransfer.items.length; i++) {
                if (ev.dataTransfer.items[i].kind === 'file') {
                    let file = ev.dataTransfer.items[i].getAsFile();
                    console.log('... file[' + i + '].name = ' + file.name);
                    uploadFile(file);
                }
            }
        } else {
            for (let i = 0; i < ev.dataTransfer.files.length; i++) {
                console.log('... file[' + i + '].name = ' + ev.dataTransfer.files[i].name);
                uploadFile(ev.dataTransfer.files[i]);
            }
        }
    }

    function handleSelectFilesChange(input) {
        console.log(input.files);
        for(let i = 0; i < input.files.length; i++) {
            let file = input.files[i];
            uploadFile(file);
        }
        // Ê∏ÖÁ©∫inputÔºåÂÖÅËÆ∏ÈáçÂ§çÈÄâÊã©Âêå‰∏ÄÊñá‰ª∂
        input.value = '';
    }

    function uploadFile(file) {
        showProgress();
        const progressId = createProgressItem(file.name, file.size);

        const formData = new FormData();
        formData.append('file', file);
        formData.append("isImg", isFileImage(file)?"1":"0");
        
        const xhr = new XMLHttpRequest();
        uploadRequests.set(progressId, xhr); // Â≠òÂÇ®ËØ∑Ê±ÇÂºïÁî®
        xhr.open('POST', '/upload', true);
        
        xhr.upload.onprogress = e => {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                updateProgress(progressId, percentComplete, 'Uploading...');
            }
        };
        
        xhr.onload = function(e) {
            uploadRequests.delete(progressId); // Ê∏ÖÁêÜËØ∑Ê±ÇÂºïÁî®
            console.log(e);
            if (xhr.status === 200) {
                updateProgress(progressId, 100, 'Completed');
                
                // Âª∂ËøüÊ∑ªÂä†Êñá‰ª∂Âà∞ÂàóË°®ÔºåËÆ©Áî®Êà∑ÁúãÂà∞ÂÆåÊàêÁä∂ÊÄÅ
                setTimeout(() => {
                    if (isFileImage(file)) {
                        let imgContainer = document.createElement("div");
                        imgContainer.className = "img-item";
                        imgContainer.innerHTML = `
                            <img src="${e.currentTarget.response}" alt="">
                            <button onclick="deleteFile('${file.name}')" class="delete-btn img-delete-btn" title="Delete image" data-filename="${file.name}">üóëÔ∏è</button>
                        `;
                        let list = document.getElementById("imgList");
                        list.insertBefore(imgContainer, list.firstChild);
                    } else {
                        let fileContainer = document.createElement("div");
                        fileContainer.className = "file-item";
                        fileContainer.innerHTML = `
                            <a href="${e.currentTarget.response}" class="file-link">${file.name}</a>
                            <button onclick="deleteFile('${file.name}')" class="delete-btn" title="Delete file">üóëÔ∏è</button>
                        `;
                        let list = document.getElementById("fileList");
                        list.insertBefore(fileContainer, list.firstChild);
                    }
                    
                    // ÁßªÈô§ËøõÂ∫¶È°π
                    const progressItem = document.getElementById(progressId);
                    if (progressItem) {
                        progressItem.remove();
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶ËøòÊúâÂÖ∂‰ªñËøõÂ∫¶È°πÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô2ÁßíÂêéËá™Âä®ÈöêËóè
                    const progressList = document.getElementById('progressList');
                    if (progressList.children.length === 0) {
                        autoHideProgress();
                    }
                }, 1000);
            } else {
                updateProgress(progressId, 0, 'Error');
                alert("Error uploading file: " + file.name + ". Please try again.");
                
                // ÈîôËØØÊÉÖÂÜµ‰∏ã‰πüÁßªÈô§ËøõÂ∫¶È°πÂπ∂Ê£ÄÊü•Ëá™Âä®ÈöêËóè
                setTimeout(() => {
                    const progressItem = document.getElementById(progressId);
                    if (progressItem) {
                        progressItem.remove();
                    }
                    
                    const progressList = document.getElementById('progressList');
                    if (progressList.children.length === 0) {
                        autoHideProgress();
                    }
                }, 3000); // ÈîôËØØÊÉÖÂÜµ‰∏ã3ÁßíÂêéÁßªÈô§
            }
        };

        xhr.onerror = function() {
            uploadRequests.delete(progressId);
            updateProgress(progressId, 0, 'Error');
            alert("Network error uploading file: " + file.name + ". Please try again.");
            
            // ÈîôËØØÊÉÖÂÜµ‰∏ã‰πüÁßªÈô§ËøõÂ∫¶È°πÂπ∂Ê£ÄÊü•Ëá™Âä®ÈöêËóè
            setTimeout(() => {
                const progressItem = document.getElementById(progressId);
                if (progressItem) {
                    progressItem.remove();
                }
                
                const progressList = document.getElementById('progressList');
                if (progressList.children.length === 0) {
                    autoHideProgress();
                }
            }, 3000); // ÈîôËØØÊÉÖÂÜµ‰∏ã3ÁßíÂêéÁßªÈô§
        };

        xhr.onabort = function() {
            uploadRequests.delete(progressId);
            updateProgress(progressId, 0, 'Cancelled');
            
            setTimeout(() => {
                const progressItem = document.getElementById(progressId);
                if (progressItem) {
                    progressItem.remove();
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÊõ¥Â§öËøõÂ∫¶È°πÔºåÈöêËóèËøõÂ∫¶Âå∫Âüü
                const progressList = document.getElementById('progressList');
                if (progressList.children.length === 0) {
                    hideProgress();
                }
            }, 2000);
        };

        xhr.send(formData);
    }

    function isFileImage(file) {
        return file && file['type'].split('/')[0] === 'image';
    }

    function dragOverHandler(ev) {
        console.log('File(s) in drop zone');
        ev.preventDefault();
    }

    // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®Â§ÑÁêÜÂõæÁâáÂà†Èô§ÊåâÈíÆ
    document.addEventListener('DOMContentLoaded', function() {
        // ‰∏∫Áé∞ÊúâÁöÑÂõæÁâáÂà†Èô§ÊåâÈíÆÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
        document.querySelectorAll('.img-delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filename = this.getAttribute('data-filename');
                if (filename) {
                    // ‰ªé "tFile/filename" ‰∏≠ÊèêÂèñ filename
                    const actualFilename = filename.replace('tFile/', '');
                    deleteFile(actualFilename);
                }
            });
        });
    });
</script>